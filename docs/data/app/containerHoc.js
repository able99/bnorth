[{"tags":[{"type":"copyright","string":"(c) 2016 able99","html":"<p>(c) 2016 able99</p>"},{"type":"author","string":"able99 (8846755@qq.com)","html":"<p>able99 (8846755@qq.com)</p>"},{"type":"license","string":"MIT","html":"<p>MIT</p>"}],"description":{"full":"<p>bnorth solution</p>","summary":"<p>bnorth solution</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":1,"codeStart":9,"code":"import { connect } from 'react-redux'\nimport { bindActionCreators } from 'redux'\n\n\nfunction getContainerKey(app, props) {\n  let key = 'ck';\n  for(let route of props.routes){\n    if(route.path) {\n      key+='-'+route.path\n    }\n    if(route===props.route) {\n      break;\n    }\n  }\n  return key;\n}\n\nfunction getContainer(app, props, acontainer, cb) {\n  if(!acontainer) return;\n  let key = getContainerKey(app, props); \n  let container = acontainer[key];\n\n  if(!container){\n    container = {\n      states:app.actionStates.data?{data: app.actionStates.data()}:{},\n      reducers: {},\n      actions:{},\n      handlers: {},\n    }\n\n    if(acontainer!==true) {\n      try{\n        acontainer(app, props, container);\n      }catch(e){\n        app.error(e);\n        app.errorRender(e,'container error');\n      }\n      acontainer[key] = container;\n    }\n    cb&&cb(container);\n  }\n\n  return container;\n}\n\nfunction statesHandler(states, event) {\n  Object.entries(states||{})\n  .forEach(([key,val])=>{\n    if(!key||key[0]==='_') return;\n    let func = val&&val[event];\n    if(func)func.apply(val);\n  })\n}\n\n\nexport default function(app, acontainer) {\n  if(Array.isArray(acontainer)) return connect(...acontainer);\n\n  let mapState = (state, props)=>{\n    let container = getContainer(app, props, acontainer, (container)=>{\n      container.actions = bindActionCreators(container.actions, app.actionStore.dispatch);\n    });\n\n    let ret = {};\n    if(!container) return ret;\n    Object.entries(container.reducers||{}).forEach(([key,v])=>{\n      if(v===true)ret[\"state_\"+key] = state[v===true?key:v];\n    });\n    Object.entries(container.states||{}).forEach(([key,v])=>{\n      ret[\"state_\"+key] = v.state;\n      for(let [skey, val] of Object.entries(v.states||{})){\n        ret[`state_${key}_${skey}`] = val;\n      }\n    });\n    return ret;\n  }\n\n  let mapDispatch = (dispatch, props)=>{\n    let container = getContainer(app, props, acontainer);\n    if(!container) return {app};\n\n    return {\n      app,\n      container,\n      states: container.states,\n\n      onWillStart(page) {\n        if(container.handlers.onWillStart)container.handlers.onWillStart(app,page,container);\n      },\n      onStart(page) {\n        if(container.handlers.onStart)container.handlers.onStart(app,page,container);\n        statesHandler(container.states, 'onStart');\n      },\n      onPause(page) {\n        if(container.handlers.onPause)container.handlers.onPause(app,page,container);\n        statesHandler(container.states, 'onPause');\n      },\n      onResume(page) {\n        if(container.handlers.onResume)container.handlers.onResume(app,page,container);\n        statesHandler(container.states, 'onResume');\n      },\n      onStop(page) {\n        if(container.handlers.onStop)container.handlers.onStop(app,page,container);\n        statesHandler(container.states, 'onStop');\n      }\n    }\n  }\n\n  return connect(mapState, mapDispatch);\n}","ctx":false},{"tags":[{"type":"function","string":"","html":""},{"type":"param","string":"{App} app - App 的实例","name":"app","description":"<ul>\n<li>App 的实例</li>\n</ul>","types":["App"],"typesDescription":"<a href=\"App.html\">App</a>","optional":false,"nullable":false,"nonNullable":false,"variable":false},{"type":"param","string":"{object} props - 组件的属性","name":"props","description":"<ul>\n<li>组件的属性</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false},{"type":"param","string":"{object} container - container模板，在此函数中，扩展该属性","name":"container","description":"<ul>\n<li>container模板，在此函数中，扩展该属性</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false},{"type":"example","string":"```js\nexport default function(app, props, container) {\n  container.states.data = app.actionStates.data({});\n}\n```","html":"<pre><code class=\"lang-js\">export default function(app, props, container) {\n  container.states.data = app.actionStates.data({});\n}\n</code></pre>"}],"description":{"full":"<p>container函数是页面组件的逻辑控制函数，为页面组件提供数据和actions 供页面组件调用<br />\nbnorth 会自动通过高阶函数containerHoc 进行连接</p>","summary":"<p>container函数是页面组件的逻辑控制函数，为页面组件提供数据和actions 供页面组件调用<br />\nbnorth 会自动通过高阶函数containerHoc 进行连接</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":120,"codeStart":134},{"tags":[{"type":"class","string":"container","html":"<p>container</p>"},{"type":"example","string":"```js\nexport default function(app, props, container) {\n  container.states.data = app.actionStates.data({});\n  container.actions.test = ()=>()=>{};\n  container.handler.onStart = ()=>{};\n}\n```","html":"<pre><code class=\"lang-js\">export default function(app, props, container) {\n  container.states.data = app.actionStates.data({});\n  container.actions.test = ()=&gt;()=&gt;{};\n  container.handler.onStart = ()=&gt;{};\n}\n</code></pre>"}],"description":{"full":"<p>container 类，容器组件的类，用以实现逻辑<br />\n通过在container 函数中，扩展container类实例的方式实现</p>","summary":"<p>container 类，容器组件的类，用以实现逻辑<br />\n通过在container 函数中，扩展container类实例的方式实现</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":true,"isEvent":false,"ignore":false,"line":135,"codeStart":148},{"tags":[{"type":"property","string":"{state[]} states","name":"states","description":"","types":["Array.<state>"],"typesDescription":"<code>Array</code>.&lt;<a href=\"state.html\">state</a>&gt;","optional":false,"nullable":false,"nonNullable":false,"variable":false,"html":"<p>{state[]} states</p>"}],"description":{"full":"","summary":"","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":149,"codeStart":153},{"tags":[{"type":"property","string":"{string[]} reduxers","name":"reduxers","description":"","types":["Array.<string>"],"typesDescription":"<code>Array</code>.&lt;<code>string</code>&gt;","optional":false,"nullable":false,"nonNullable":false,"variable":false,"html":"<p>{string[]} reduxers</p>"}],"description":{"full":"","summary":"","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":154,"codeStart":158},{"tags":[{"type":"property","string":"{action[]} actions","name":"actions","description":"","types":["Array.<action>"],"typesDescription":"<code>Array</code>.&lt;<a href=\"action.html\">action</a>&gt;","optional":false,"nullable":false,"nonNullable":false,"variable":false,"html":"<p>{action[]} actions</p>"}],"description":{"full":"","summary":"","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":159,"codeStart":163},{"tags":[{"type":"property","string":"{function[]} handler","name":"handler","description":"","types":["Array.<function>"],"typesDescription":"<code>Array</code>.&lt;<code>function</code>&gt;","optional":false,"nullable":false,"nonNullable":false,"variable":false,"html":"<p>{function[]} handler</p>"}],"description":{"full":"","summary":"","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":164,"codeStart":168}]