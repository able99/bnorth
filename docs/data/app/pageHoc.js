[{"tags":[{"type":"copyright","string":"(c) 2016 able99","html":"<p>(c) 2016 able99</p>"},{"type":"author","string":"able99 (8846755@qq.com)","html":"<p>able99 (8846755@qq.com)</p>"},{"type":"license","string":"MIT","html":"<p>MIT</p>"}],"description":{"full":"<p>bnorth solution</p>","summary":"<p>bnorth solution</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":1,"codeStart":9,"code":"import React from 'react';\nimport uuid from '../utils/uuid';\nimport { setBrowserTitle } from '../utils/browser';","ctx":false},{"tags":[{"type":"class","string":"Page","html":"<p>Page</p>"}],"description":{"full":"<p>bnorth 中页面Page 组件的基类，bnorth 会自动将react 组件通过高级函数pageHoc 进行超类扩展，负责纯组件的渲染，使用container 注入的props，一般无需使用state<br />\n<strong>props 注入</strong> 页面Page 的props 除react 属性外注入包括：</p>\n<ol>\n<li><strong>this.app</strong>： App 类的实例</li>\n<li><strong>this.props.container</strong>： 与page 对应的container 的实例，可操作对应的actions，states</li>\n<li><strong>this.props.state_xxx</strong>： bnorth state 注入的数据</li>\n<li><strong>this.props.params|location|route|routes|router</strong>： react router注入的属性，具体参见<a href=\"https://github.com/ReactTraining/react-router/tree/v3/docs\">react-router 3</a><br />\n<strong>render</strong></li>\n<li>page render 时，将子组件修改为与自己同级，保证互相不影响，因此页面page 的元素应该是绝对定位到左上角的，可使用bnorth-components 的View 组件</li>\n<li>render 错误时会触发onErrorPageRender 事件</li>\n</ol>","summary":"<p>bnorth 中页面Page 组件的基类，bnorth 会自动将react 组件通过高级函数pageHoc 进行超类扩展，负责纯组件的渲染，使用container 注入的props，一般无需使用state<br />\n<strong>props 注入</strong> 页面Page 的props 除react 属性外注入包括：</p>\n<ol>\n<li><strong>this.app</strong>： App 类的实例</li>\n<li><strong>this.props.container</strong>： 与page 对应的container 的实例，可操作对应的actions，states</li>\n<li><strong>this.props.state_xxx</strong>： bnorth state 注入的数据</li>\n<li><strong>this.props.params|location|route|routes|router</strong>： react router注入的属性，具体参见<a href=\"https://github.com/ReactTraining/react-router/tree/v3/docs\">react-router 3</a><br />\n<strong>render</strong></li>\n<li>page render 时，将子组件修改为与自己同级，保证互相不影响，因此页面page 的元素应该是绝对定位到左上角的，可使用bnorth-components 的View 组件</li>\n<li>render 错误时会触发onErrorPageRender 事件</li>\n</ol>","body":""},"isPrivate":false,"isConstructor":false,"isClass":true,"isEvent":false,"ignore":false,"line":14,"codeStart":26,"code":"export default (app, Wrapper) => class extends Wrapper {\n  constructor(props) {\n    super(props);\n    this.app = app;\n    this._focus = false;\n  }\n\n  componentWillMount() {\n    app.pages.push(this);\n    if(this.props.onWillStart) this.props.onWillStart(this);\n    return super.componentWillMount && super.componentWillMount();\n  }\n\n  componentDidMount() {\n    if(this.props.onStart) this.props.onStart(this);\n    if(this.checkFocusChange()){this.componentDidResume();}\n    return super.componentDidMount && super.componentDidMount();\n  }\n\n  componentDidUpdate(prevProps) {\n    if(this.checkFocusChange()){\n      if(this.isFocus()){\n        this.componentDidResume();\n      }else{\n        this.componentDidPause();\n      }\n    }\n\n    return super.componentDidUpdate && super.componentDidUpdate();\n  }\n\n  componentWillUnmount() {\n    this.componentDidPause();\n\n    if(this.props.onStop) this.props.onStop(this);\n    let ret = super.componentWillUnmount && super.componentWillUnmount();\n\n    app.pages.splice(app.pages.indexOf(this));\n    return ret;\n  }\n\n  componentDidPause() {\n    if(this.props.onPause) this.props.onPause(this);\n    return super.componentDidPause && super.componentDidPause();\n  }\n\n  componentDidResume() {\n    setBrowserTitle(this.props.route.title||app.config.browser.title);\n    if(this.props.onResume) this.props.onResume(this);\n    return super.componentDidResume && super.componentDidResume();\n  }\n\n  componentDidBackKey() {\n    if(this.props.onBackKey) this.props.onBackKey(this);\n    return super.componentDidBackKey && super.componentDidBackKey();\n  }\n\n  render(){\n    let name = Wrapper.displayName||Wrapper.name;\n    app.verbose(`page render(${name}):`,this);\n\n    if(this.props.state__page.ready===false){\n      return null;\n    }\n\n    let ret;\n    try{\n      ret = super.render();\n    }catch(e){\n      return app.trigger('onErrorPageRender', e);\n    }\n\n    ret = React.cloneElement( ret, Object.assign( {\n      'data-bnorth-page': name, \n      'data-blur': !this.isFocus(),\n    }, ret.props));\n    \n    if(this.getSubs().indexOf(this.getPageChildPath())>=0){\n      return (\n        <div>\n          {ret}\n          {!this.isAppPage()?this.props.state__page.layers.map(v=>v.element):null}\n          {this.props[this.getPageChildPath()] && this.props[this.getPageChildPath()].props.children}\n          {this.isAppPage()?this.props.state__page.layers.map(v=>v.element):null}\n        </div>\n      );\n    }else{\n      return (\n        <div>\n          {ret}\n          {!this.isAppPage()?this.props.state__page.layers.map(v=>v.element):null}\n          {this.isSubPage()?null:this.props.children}\n          {this.isAppPage()?this.props.state__page.layers.map(v=>v.element):null}\n        </div>\n      );\n    }\n  }","ctx":false},{"tags":[{"type":"method","string":"","html":""}],"description":{"full":"<p>返回是否是App 根组件</p>","summary":"<p>返回是否是App 根组件</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":true,"line":124,"codeStart":128,"code":"isAppPage() {\n  return this.props.routes[0]===this.props.route;\n}\n\ncheckFocusChange() {\n  let oldFocus = this._focus;\n  this._focus = this.isFocus();\n  return this._focus !== oldFocus;\n}","ctx":{"type":"method","name":"isAppPage","string":"isAppPage()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{boolean}","types":["boolean"],"typesDescription":"<code>boolean</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"","html":"<p>{boolean}</p>"}],"description":{"full":"<p>返回是否页面在顶层</p>","summary":"<p>返回是否页面在顶层</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":138,"codeStart":143,"code":"isFocus() {\n  if(this.getSubs().hasOwnProperty(this.getPageChildPath())){\n    return !Boolean(this.props[this.getPageChildPath()] && this.props[this.getPageChildPath()].props.children);\n  }else{\n    return !Boolean(this.props.children);\n  }\n}","ctx":{"type":"method","name":"isFocus","string":"isFocus()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{boolean}","types":["boolean"],"typesDescription":"<code>boolean</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"","html":"<p>{boolean}</p>"}],"description":{"full":"<p>返回是否是容器组件</p>","summary":"<p>返回是否是容器组件</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":151,"codeStart":156,"code":"isContainer() {\n  return (this.props.route.childRoutes||[]).find((v)=>{\n    return v.components;\n  });\n}","ctx":{"type":"method","name":"isContainer","string":"isContainer()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{array} - 子组件的名称数组","types":["array"],"typesDescription":"<code>array</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"<ul>\n<li>子组件的名称数组</li>\n</ul>"}],"description":{"full":"<p>容器组件返回其子组件列表</p>","summary":"<p>容器组件返回其子组件列表</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":162,"codeStart":167,"code":"getSubs() {\n  return (this.props.route.childRoutes||[])\n  .filter((v)=>{\n    return v.components;\n  })\n  .map((v)=>{\n    return v.path;\n  });\n}","ctx":{"type":"method","name":"getSubs","string":"getSubs()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{boolean}","types":["boolean"],"typesDescription":"<code>boolean</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"","html":"<p>{boolean}</p>"}],"description":{"full":"<p>是否是子组件</p>","summary":"<p>是否是子组件</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":177,"codeStart":182,"code":"isSubPage() {\n  return Boolean(this.props.route.components);\n}","ctx":{"type":"method","name":"isSubPage","string":"isSubPage()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{string}","types":["string"],"typesDescription":"<code>string</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"","html":"<p>{string}</p>"}],"description":{"full":"<p>返回当前页面的全路径</p>","summary":"<p>返回当前页面的全路径</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":186,"codeStart":191,"code":"getPageFullPath() {\n  let routes = [];\n  for(let route of this.props.routes){\n    if(!route.path) continue;\n    routes.push(route.path===\"/\"?\"\":route.path);\n    if(route===this.props.route) break;\n  }\n  let pathname = routes.join(\"/\");\n  for (let key in this.props.router.params) {\n    let re = new RegExp(\":\"+key,\"g\"); \n    pathname = pathname.replace(re,this.props.router.params[key]);\n  }\n  return pathname;\n}","ctx":{"type":"method","name":"getPageFullPath","string":"getPageFullPath()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{string}","types":["string"],"typesDescription":"<code>string</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"","html":"<p>{string}</p>"}],"description":{"full":"<p>容器组件返回当前显示中的子组件路径</p>","summary":"<p>容器组件返回当前显示中的子组件路径</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":206,"codeStart":211,"code":"getPageChildPath() {\n  let ret = null;\n  for(let i=0; i<this.props.routes.length; i++){\n    let route = this.props.routes[i];\n    if(!route.path) continue;\n    if(route===this.props.route) {\n      ret = this.props.routes[i+1];\n      break;\n    }\n  }\n  return ret?ret.path:null;\n}","ctx":{"type":"method","name":"getPageChildPath","string":"getPageChildPath()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{string}","types":["string"],"typesDescription":"<code>string</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"","html":"<p>{string}</p>"}],"description":{"full":"<p>子组件返回其容器组件的路径</p>","summary":"<p>子组件返回其容器组件的路径</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":224,"codeStart":229,"code":"getPageParentPath() {\n  let ret = null;\n  for(let i=0; i<this.props.routes.length; i++){\n    let route = this.props.routes[i];\n    if(!route.path) continue;\n    if(route===this.props.route) break;\n    ret = route.path;\n  }\n  return ret\n}\n\naddLayer(element) {\n  let uuidstr = uuid(8,16);\n  this.props.container.states._page.update({\n    layers: [...this.props.state__page.layers, {uuid: uuidstr, element}]\n  });\n\n  return uuidstr;\n}\n\nupdateLayer(element, uuid) {\n  this.props.container.states._page.update({\n    layers: this.props.state__page.layers.map(v=>(\n      v.uuid!==uuid?v:{element, uuid}\n    )),\n  });\n}\n\nremoveLayer(uuid) {\n  this.props.container.states._page.update({\n    layers: this.props.state__page.layers.filter(v=>v.uuid!==uuid)\n  });\n}\n}","ctx":{"type":"method","name":"getPageParentPath","string":"getPageParentPath()"}}]