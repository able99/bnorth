[{"tags":[{"type":"copyright","string":"(c) 2016 able99","html":"<p>(c) 2016 able99</p>"},{"type":"author","string":"able99 (8846755@qq.com)","html":"<p>able99 (8846755@qq.com)</p>"},{"type":"license","string":"MIT","html":"<p>MIT</p>"}],"description":{"full":"<p>bnorth solution</p>","summary":"<p>bnorth solution</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":1,"codeStart":9,"code":"import md5 from '../utils/md5';","ctx":false},{"tags":[{"type":"class","string":"","html":""}],"description":{"full":"<p>用户信息与鉴权</p>","summary":"<p>用户信息与鉴权</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":true,"isEvent":false,"ignore":false,"line":12,"codeStart":16,"code":"class User {","ctx":{"type":"class","constructor":"User","cons":"User","name":"User","extends":"","string":"new User()"}},{"tags":[{"type":"constructor","string":"","html":""},{"type":"param","string":"{App} app - App 单实例","name":"app","description":"<ul>\n<li>App 单实例</li>\n</ul>","types":["App"],"typesDescription":"<a href=\"App.html\">App</a>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"","summary":"","body":""},"isPrivate":false,"isConstructor":true,"isClass":false,"isEvent":false,"ignore":false,"line":17,"codeStart":21,"code":"constructor(app){\n  this.app = app;\n}\n\n// user state\n// ---------------------------------","ctx":{"type":"constructor","constructor":"User","cons":"User","name":"constructor","string":"User.prototype.constructor()"}},{"tags":[{"type":"method","string":"","html":""}],"description":{"full":"<p>更新用户信息与登录状态</p>","summary":"<p>更新用户信息与登录状态</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":27,"codeStart":31,"code":"update(){\n  this.state().update();\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"update","string":"User.prototype.update()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{boolean} - 是否登录","types":["boolean"],"typesDescription":"<code>boolean</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"<ul>\n<li>是否登录</li>\n</ul>"}],"description":{"full":"<p>是否已登录</p>","summary":"<p>是否已登录</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":35,"codeStart":40,"code":"isLogin(){\n  let user = this.load();\n  return Boolean(user&&user.token);\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"isLogin","string":"User.prototype.isLogin()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"param","string":"{*} result - 用户信息","name":"result","description":"<ul>\n<li>用户信息</li>\n</ul>","types":[],"typesDescription":"<code>*</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"<p>获取或更新用户信息成功的处理函数，信息追加的方式保存到用户缓存中</p>","summary":"<p>获取或更新用户信息成功的处理函数，信息追加的方式保存到用户缓存中</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":45,"codeStart":50,"code":"_stateSuccess (result){\n  this.save(Object.assign(this.load(),result||{}));\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"_stateSuccess","string":"User.prototype._stateSuccess()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"param","string":"{Error|string} error - 错误信息","name":"error","description":"<ul>\n<li>错误信息</li>\n</ul>","types":["Error","string"],"typesDescription":"<code>Error</code>|<code>string</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"<p>获取或更新用户信息失败的处理函数</p>","summary":"<p>获取或更新用户信息失败的处理函数</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":54,"codeStart":59,"code":"_stateError (error){\n  \n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"_stateError","string":"User.prototype._stateError()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{string} - 接口地址","types":["string"],"typesDescription":"<code>string</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"<ul>\n<li>接口地址</li>\n</ul>"}],"description":{"full":"<p>获取用户信息的网络接口地址</p>","summary":"<p>获取用户信息的网络接口地址</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":63,"codeStart":68,"code":"_getInfoUrl() {\n  let authUrl = this.app.config.login.urls['info'];;\n  return this.app.config.urls.base+this.app.config.urls.api+authUrl;\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"_getInfoUrl","string":"User.prototype._getInfoUrl()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{ActionStateRequest} - request state","types":["ActionStateRequest"],"typesDescription":"<a href=\"ActionStateRequest.html\">ActionStateRequest</a>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"<ul>\n<li>request state</li>\n</ul>"}],"description":{"full":"<p>返回用户信息请求的ActionState，uuid 为user，可添加到container states 中，获取与跟踪用户信息数据</p>","summary":"<p>返回用户信息请求的ActionState，uuid 为user，可添加到container states 中，获取与跟踪用户信息数据</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":73,"codeStart":78,"code":"state(){\n  return this.app.actionStates.request&&this.app.actionStates.request({\n    updateOnStart: true,\n    clearOnStop: false,\n    resource: this._getInfoUrl(),\n    onWillUpdate:()=>this.isLogin(),\n    onWillChange:(result)=>{\n      this._stateSuccess(result);\n    },\n    onChangeError:(error)=>{\n      this._stateError(error);\n    },\n  },\"user\");\n}\n\n\n// user info\n// --------------------------------","ctx":{"type":"method","constructor":"User","cons":"User","name":"state","string":"User.prototype.state()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{string} - token","types":["string"],"typesDescription":"<code>string</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"<ul>\n<li>token</li>\n</ul>"}],"description":{"full":"<p>返回缓存的用户token</p>","summary":"<p>返回缓存的用户token</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":96,"codeStart":101,"code":"getToken(){\n  let user = this.load();\n  return user?user.token:\"\";\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"getToken","string":"User.prototype.getToken()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"return","string":"{object} - 用户信息","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false,"description":"<ul>\n<li>用户信息</li>\n</ul>"}],"description":{"full":"<p>返回缓存用户信息</p>","summary":"<p>返回缓存用户信息</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":106,"codeStart":111,"code":"load(){\n  return (this.app.storage&&this.app.storage.getObj(this.app.config.keys.user))||{};\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"load","string":"User.prototype.load()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"param","string":"{object} user - 用户信息","name":"user","description":"<ul>\n<li>用户信息</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"<p>替换缓存的用户信息</p>","summary":"<p>替换缓存的用户信息</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":115,"codeStart":120,"code":"save(user){\n  return this.app.storage&&this.app.storage.setObj(this.app.config.keys.user,user);\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"save","string":"User.prototype.save()"}},{"tags":[{"type":"method","string":"","html":""}],"description":{"full":"<p>清除缓存的用户信息</p>","summary":"<p>清除缓存的用户信息</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":124,"codeStart":128,"code":"clear(){\n  this.state().clear();\n  return this.app.storage&&this.app.storage.remove(this.app.config.keys.user);\n}\n\n\n// user login\n// ---------------------------\n_getLoginUrl(data,options) {\n  if(typeof(options)==='string') return options;\n  \n  let { type=this.app.config.login.types[0].type } = options||{};\n  let authUrl = this.app.config.login.urls[type];\n  return this.app.config.urls.base+this.app.config.urls.api+authUrl;\n}\n_getLoginMethod(data,options) {\n  return 'post';\n}\n_getPasswordCrypto(password) {\n  return md5(password);\n}\n_getLoginData(data,options) {\n  let { fields, data:adata={} } = options||{};\n  let ret = {};\n\n  if(fields){\n    fields.forEach(v=>{\n      ret[v.type] = v.crypto?this._getPasswordCrypto(data[v.type]):data[v.type];\n    })\n  }else{\n    ret = data;\n  }\n\n  return Object.assign(ret, adata||{});\n}\n_loginBefore(data,options) {\n  return [data, options];\n}\n_loginRequest(data, options) {\n  let { type, fields, success, data:adata, ...params } = options||{};\n\n  this.app.actions.requestSubmit && this.app.actions.requestSubmit({\n    resource: this._getLoginUrl(data,options),\n    method: this._getLoginMethod(data,options),\n    data: this._getLoginData(data,options),\n    noAuth: true,\n    success:(result)=>{\n      this._loginSuccess(result, options);\n    },\n    ...params,\n  });\n}\n_loginSuccess(result, options) {\n  let { success } = options||{};\n\n  if(success&&success(result, options)) return;\n  this.app.trigger('onUserUpdate', result);\n  result = this._loginAfter(result,options)||result;\n  this._loginNavigate(result,options);\n}\n_loginAfter(result,options) {\n  this.save(result);\n}\n_loginNavigate(result,options) {\n  this.app.navigator&&this.app.navigator.recall();\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"clear","string":"User.prototype.clear()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"param","string":"{object} data - 登录的参数 ","name":"data","description":"<ul>\n<li>登录的参数</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false},{"type":"param","string":"{object} options -  登录的配置","name":"options","description":"<ul>\n<li>登录的配置</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"<p>用户登录</p>","summary":"<p>用户登录</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":194,"codeStart":200,"code":"login(data,options) {\n  this._loginRequest(...this._loginBefore(data, options));\n}\n\n// user logout\n//===========\n_getLogoutUrl(data, options) {\n  let url = this.app.config.login.urls['logout']||'';\n  return url.indexOf('http')>=0?url:this.app.config.urls.base+this.app.config.urls.api+url;\n}\n_getLogoutMethod(data, options) {\n  return this.app.config.login.logoutMethod||'DELETE';\n}\n_getLogoutData(data, options) {\n  return data||this.app.config.login.logoutData||{};\n}\n_logoutNetwork(data, options){\n  this.app.actions.requestSubmit && this.app.actions.requestSubmit({\n    resource: this._getLogoutUrl(data, options),\n    method: this._getLogoutMethod(data, options),\n    data:this._getLogoutData(data, options),\n    ...options||{},\n  });\n}\n_logoutAfter(data, options){\n  this.clear();\n}\n_logoutNavigate(data, options){\n  if(this.app.navigator){ this.app.config.login.logoutToLoginOrHome?this.app.navigator.goLogin():this.app.navigator.goHome(); }\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"login","string":"User.prototype.login()"}},{"tags":[{"type":"method","string":"","html":""},{"type":"param","string":"{object} data - 登出参数","name":"data","description":"<ul>\n<li>登出参数</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false},{"type":"param","string":"{object} options - 参数","name":"options","description":"<ul>\n<li>参数</li>\n</ul>","types":["object"],"typesDescription":"<code>object</code>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"<p>用户登出</p>","summary":"<p>用户登出</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":231,"codeStart":237,"code":"logout(data, options){\n  this._logoutNetwork(data, options);\n  this._logoutAfter(data, options);\n  this.app.trigger('onUserUpdate',{});\n  this._logoutNavigate(data, options);\n}\n}","ctx":{"type":"method","constructor":"User","cons":"User","name":"logout","string":"User.prototype.logout()"}},{"tags":[{"type":"class","string":"userPlugin","html":"<p>userPlugin</p>"},{"type":"property","string":"{class} app.User - User 类","name":"app.User","description":"<ul>\n<li>User 类</li>\n</ul>","types":["class"],"typesDescription":"<a href=\"class.html\">class</a>","optional":false,"nullable":false,"nonNullable":false,"variable":false},{"type":"property","string":"{User} app.user - User 类实例","name":"app.user","description":"<ul>\n<li>User 类实例</li>\n</ul>","types":["User"],"typesDescription":"<a href=\"User.html\">User</a>","optional":false,"nullable":false,"nonNullable":false,"variable":false}],"description":{"full":"<p><strong>plugin</strong> name: user dependence: request, navigator, storage event: onUserUpdate({*}user) handle: onNavigating<br />\n用户信息与鉴权的能力扩展</p>","summary":"<p><strong>plugin</strong> name: user dependence: request, navigator, storage event: onUserUpdate({*}user) handle: onNavigating<br />\n用户信息与鉴权的能力扩展</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":true,"isEvent":false,"ignore":false,"line":246,"codeStart":253,"code":"export default {\n  name: 'user',\n  dependence: ['request', 'navigator', 'storage'],\n\n  init(app) {\n    app.User = User;\n    app.user = new User(app);\n  },\n\n  onNavigating(app, nextState) {\n    if(nextState.routes.find(v=>v.checkLogin)&&!app.user.isLogin()){\n      return typeof(app.config.paths.Login)==='string'?app.config.paths.Login:app.config.paths.Login.path;\n    }\n  },\n}","ctx":false}]