[{"tags":[{"type":"copyright","string":"(c) 2016 able99","html":"<p>(c) 2016 able99</p>"},{"type":"author","string":"able99 (8846755@qq.com)","html":"<p>able99 (8846755@qq.com)</p>"},{"type":"license","string":"MIT","html":"<p>MIT</p>"}],"description":{"full":"<p>bnorth solution</p>","summary":"<p>bnorth solution</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":false,"isEvent":false,"ignore":false,"line":1,"codeStart":9,"code":"import Url from 'url-parse';","ctx":false},{"tags":[{"type":"class","string":"","html":""},{"type":"example","string":"**使用**\napp.navigator.xxx\n**hook**\n参见Browser hook说明","html":"<p><strong>使用</strong><br />\napp.navigator.xxx<br />\n<strong>hook</strong><br />\n参见Browser hook说明</p>"}],"description":{"full":"<p>为app 提供导航的能力扩展，导航一般区别与browser 插件中的插件，导航指app 应用内的导航</p>","summary":"<p>为app 提供导航的能力扩展，导航一般区别与browser 插件中的插件，导航指app 应用内的导航</p>","body":""},"isPrivate":false,"isConstructor":false,"isClass":true,"isEvent":false,"ignore":false,"line":12,"codeStart":21,"code":"class Navigator{\n  constructor(app){\n    this.app = app;\n    this.recallLocation = null;\n    this.routerStatus = null;\n  }\n\n  _navi(type,...args){\n    if(!this.routerStatus) return;\n    let {location,router,} = this.routerStatus;\n\n    if(type==='back'){\n      router.go(...args);\n      return;\n    }\n\n    if(!args.length){\n      type==='replace'?router.replace(\"/\"):router.push(\"/\");\n      return;\n    }\n\n    let paths = [];\n    let extern = false;\n    let absolute = false;\n    let passState = false;\n    let passQuery = false;\n    let uper = 0;\n    let newloc = {\n      pathname: '',\n    };\n\n    for(let arg of args){\n      if(Array.isArray(arg)){\n        [\n          newloc.query,\n          passQuery,\n          newloc.state,\n          passState,\n        ] = arg;\n      }\n    }\n\n    for(let arg of args){\n      if(!arg){\n        this.app.error('invalided navigator params');\n        return;\n      }else if(Array.isArray(arg)){\n        \n      }else if(typeof(arg)===\"object\"){\n        extern = extern || arg.extern || (arg.path && arg.path.indexOf(\"http\")===0);\n        absolute = absolute || arg.absolute || (arg.path && arg.path.indexOf(\"/\")===0);\n\n        if(arg.path===\"/\"){continue}\n        if(arg.path===\".\"){continue}\n        if(arg.path===\"..\"){uper++;continue}\n      \n        if(arg.path) {\n          let apath = [arg.path];\n          if(newloc.query&&Array.isArray(arg.params)&&arg.params.length){\n            arg.params.forEach((v)=>{\n              if(newloc.query[v]) apath.push(newloc.query[v]);\n              delete newloc.query[v];\n            });\n          }\n          paths.push(apath.join('/'));\n        }\n      }else{\n        arg = arg||\"\";\n        if(!arg){continue}\n\n        let aextern = (paths.length===0&&arg.indexOf(\"http\")===0);\n        let aabsolute = (paths.length===0&&arg.indexOf(\"/\")===0);\n        extern = extern || aextern;\n        absolute = absolute || aabsolute;\n\n        if(arg===\"/\"){continue}\n        if(arg===\".\"){continue}\n        if(arg===\"..\"){uper++;continue}\n\n        if(arg) paths.push(aextern||aabsolute?arg:encodeURIComponent(arg));\n      }\n    }\n\n    if(!absolute&&!extern){\n      if(uper<=0){\n        newloc.pathname = location.pathname;\n      }else{\n        newloc.pathname = router.routes.slice(1,-uper).map((v)=>{return (v.path||\"\")}).join(\"/\");\n        for (let key in router.params) {\n          let re = new RegExp(\":\"+key,\"g\"); \n          newloc.pathname = newloc.pathname.replace(re,router.params[key]);\n        }\n      }\n    }\n    newloc.pathname = (newloc.pathname?[newloc.pathname]:[]).concat(paths).join(\"/\");\n    if(!extern)newloc.pathname = newloc.pathname.replace(/\\/\\//g,'/');\n    newloc.state = Object.assign({},passState?location.state:{},newloc.state);\n    newloc.query = Object.assign({},passQuery?location.query:{},newloc.query);\n    if(!Object.keys(newloc.query).length)delete newloc.query;\n    if(!Object.keys(newloc.state).length)delete newloc.state;\n\n    if(type==='getUrl'){\n      if(extern){\n\n      }else{\n        let ret = new Url(window.location.href);\n        ret.set('hash', router.createHref(newloc));\n        return ret.toString();\n      }\n      return '';\n    }\n    if(extern&&this.app.browser){\n      type==='replace'?this.app.browser.replace(newloc):this.app.browser.push(newloc);\n    }else{\n      type==='replace'?router.replace(newloc):router.push(newloc);\n    }\n  }\n\n  // interface\n  // ----------------------------\n  recallBefore(location,router) {\n    if(this.app.config.login.loginToHomeOrAuto) {\n      this.goHome();\n      return true;\n    }\n    \n    let link = this.app.browser&&this.app.browser.parseUrl().query.link;\n    if(link){\n      this.app.browser&&this.app.browser.replace(decodeURIComponent(link));\n      return true;\n    }\n    \n    if(location.query.link){\n      this.app.browser&&this.app.browser.replace(decodeURIComponent(location.query.link));\n      return true;\n    }\n  }\n  recall(){\n    if(!this.routerStatus)return;\n    let {location,router} = this.routerStatus;\n    \n    if(this.recallBefore(location,router)) return;\n\n    if(this.recallLocation && this.recallLocation.isReplace) {\n      router.replace(this.recallLocation);\n    }else if(this.recallLocation) {\n      this.back();\n    }else {\n      this.goHome(true);\n    }\n  }\n\n  push(...args){\n    this._navi('push',...args);\n  }\n  back(step=1){\n    this._navi('back',-step);\n  }\n  replace(...args){\n    this._navi('replace',...args);\n  }\n  getUrl(...args){\n    return this._navi('getUrl',...args);\n  }\n  exit(){\n    window.close();\n  }\n\n  // event\n  // --------------------\n  onRouterStatusChange(routerStatus){\n    if(!routerStatus)return;\n\n    if(routerStatus.location.pathname===(typeof(this.app.config.paths.Login)==='string'?this.app.config.paths.Login:this.app.config.paths.Login.path)){\n      if(this.recallLocation&&this.routerStatus&&this.routerStatus.location.pathname!==routerStatus.location.pathname)this.recallLocation.isReplace = routerStatus.location.action==='REPLACE';\n    }else{\n      this.recallLocation = routerStatus.location;\n    }\n    this.routerStatus = routerStatus;\n  }\n}\n\n\nexport default {\n  init(app) {\n    app.Navigator = Navigator;\n    app.navigator = new Navigator(app);\n  },\n\n  onImportRoutesAfter(app) {\n    for(let key of Object.keys(app.config.paths)){\n      if(key&&key[0].match(/^[A-Z]$/)){\n        app.Navigator.prototype[`go${key}`] = function(replace){\n          let path = app.config.paths[key];\n          replace?this.replace(path):this.push(path); \n        }\n      }\n    }\n  },\n\n  onNavigated(app, location) {\n    app.navigator.onRouterStatusChange(location);\n  },\n\n  onNavigatePrevent(app, location) {\n    app.navigator.onRouterStatusChange(location);\n  }\n}","ctx":{"type":"class","constructor":"Navigator","cons":"Navigator","name":"Navigator","extends":"","string":"new Navigator()"}}]